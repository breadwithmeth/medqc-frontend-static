<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MedQC — Demo UI</title>
  <style>
    :root { --gap: 14px; --radius: 12px; --border: 1px solid #e5e7eb; --bg: #f9fafb; --bg2: #ffffff; --muted:#6b7280; --ok:#16a34a; --warn:#d97706; --err:#dc2626; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: #111827; }
    header { position: sticky; top: 0; background: var(--bg2); border-bottom: var(--border); padding: 12px 18px; display: flex; gap: 10px; align-items: center; justify-content: space-between; z-index: 1;}
    header h1 { font-size: 16px; margin: 0; }
    main { max-width: 980px; margin: 22px auto; padding: 0 16px 40px; display: grid; gap: var(--gap); }
    section, .card { background: var(--bg2); border: var(--border); border-radius: var(--radius); padding: 16px; }
    h2 { margin: 0 0 8px; font-size: 18px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="text"], input[type="url"], input[type="file"], select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: var(--border); background: #fff; font: inherit;
    }
    textarea { min-height: 80px; }
    button { border: 0; padding: 10px 14px; border-radius: 10px; background: #111827; color: #fff; cursor: pointer; font: inherit; }
    button.secondary { background: #374151; }
    button.ghost { background: transparent; border: var(--border); color: #111827; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .muted { color: var(--muted); font-size: 12px; }
    .pill { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: var(--border); background: #f3f4f6; }
    .grid { display: grid; gap: var(--gap); }
    .kvs { display: grid; grid-template-columns: 220px 1fr; gap: 8px 14px; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px 8px; border-bottom: var(--border); vertical-align: top; }
    thead th { position: sticky; top: 48px; background: var(--bg2); z-index: 1; }
    .sev-INFO { color: #0ea5e9; }
    .sev-WARN { color: var(--warn); }
    .sev-ERROR { color: var(--err); }
    .sev-OK { color: var(--ok); }
    code { background: #f3f4f6; padding: 2px 6px; border-radius: 6px; }
    .error { border-color: var(--err); }
    .center { display: grid; place-items: center; }
    .small { font-size: 13px; }
  </style>
</head>
<body>
  <header>
    <h1>MedQC — загрузка, проверка и отчёты</h1>
    <div class="toolbar">
      <label>
        <span class="muted">Базовый путь API</span>
        <input id="apiBase" type="text" value="/" />
      </label>
      <button class="ghost small" id="btnProbe">Проба /ingest vs /v1/ingest</button>
    </div>
  </header>

  <main class="grid">
    <section id="upload">
      <h2>1) Загрузка документа</h2>
      <div class="row">
        <label>
          <span>Файл</span>
          <input id="file" type="file" />
        </label>
        <div class="row3">
          <label>
            <span>Подразделение (dept, опционально)</span>
            <input id="dept" type="text" placeholder="therapy / surgery / ...">
          </label>
          <label>
            <span>Источник (source, опционально)</span>
            <input id="source" type="text" placeholder="upload / email / scan">
          </label>
          <label>
            <span>&nbsp;</span>
            <button id="btnUpload">Загрузить</button>
          </label>
        </div>
      </div>
      <p class="muted">Эндпоинт ожидается: <code>POST {base}/ingest</code> с <code>multipart/form-data</code> (поля: <code>file</code>, <code>dept?</code>, <code>source?</code>).</p>
      <div id="uploadResult" class="small"></div>
    </section>

    <section id="validate">
      <h2>2) Проверка</h2>
      <div class="row3">
        <label>
          <span>doc_id</span>
          <input id="docId" type="text" placeholder="из шага 1">
        </label>
        <label>
          <span>&nbsp;</span>
          <button id="btnValidate">Проверить</button>
        </label>
        <label>
          <span>&nbsp;</span>
          <button class="secondary" id="btnReport">Получить отчёт</button>
        </label>
      </div>
      <p class="muted">Эндпоинты: <code>GET {base}/validate/{doc_id}</code> и <code>GET {base}/report/{doc_id}</code>.</p>
      <div id="valResult"></div>
    </section>

    <section id="report">
      <h2>3) Отчёт по нарушениям</h2>
      <div id="reportSummary" class="kvs"></div>
      <div id="violTableWrap"></div>
    </section>

    <section class="card">
      <h2>Справка</h2>
      <div class="grid small">
        <div>Если ваш API смонтирован на <code>/v1</code>, укажите в поле выше <code>/v1</code>.</div>
        <div>Ошибки CORS решаются на бэкенде (добавьте соответствующие origin'ы).</div>
      </div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const apiBaseInput = $("apiBase");
    const fileInput = $("file");
    const deptInput = $("dept");
    const sourceInput = $("source");
    const uploadBtn = $("btnUpload");
    const uploadResult = $("uploadResult");
    const docIdInput = $("docId");
    const validateBtn = $("btnValidate");
    const reportBtn = $("btnReport");
    const valResult = $("valResult");
    const reportSummary = $("reportSummary");
    const violTableWrap = $("violTableWrap");
    const btnProbe = $("btnProbe");

    // Helpers
    const j = (x) => JSON.stringify(x, null, 2);
    const base = () => {
      let b = apiBaseInput.value.trim() || "/";
      if (!b.startsWith("http")) {
        // relative to same origin
        if (!b.startsWith("/")) b = "/" + b;
        // collapse trailing /
        if (b.length > 1 && b.endsWith("/")) b = b.slice(0, -1);
        const origin = window.location.origin;
        return origin + b;
      }
      return b.replace(/\/$/, "");
    };

    function errHtml(msg, extra) {
      const safe = (s) => ("" + s).replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
      return `<div class="card error">
        <div><strong>Ошибка:</strong> ${safe(msg)}</div>
        ${extra ? `<pre class="small">${safe(extra)}</pre>` : ""}
      </div>`;
    }

    function summaryKV(obj) {
      reportSummary.innerHTML = "";
      if (!obj) return;
      const rows = [];
      const push = (k, v) => rows.push(`<div class="muted">${k}</div><div>${v}</div>`);
      if (obj.doc_id) push("doc_id", `<code>${obj.doc_id}</code>`);
      if (obj.filename) push("Файл", obj.filename);
      if (obj.dept) push("Подразделение", obj.dept);
      if (obj.source) push("Источник", obj.source);
      if (obj.total_violations != null) push("Нарушений всего", obj.total_violations);
      if (obj.errors != null) push("Ошибок", obj.errors);
      if (obj.warnings != null) push("Предупреждений", obj.warnings);
      if (obj.passed != null) push("Пройдено", obj.passed ? "Да" : "Нет");
      if (obj.created_at) push("Создано", obj.created_at);
      reportSummary.innerHTML = `<div class="kvs">${rows.join("")}</div>`;
    }

    function renderViolations(items) {
      if (!Array.isArray(items) || !items.length) {
        violTableWrap.innerHTML = '<div class="muted">Нарушений не найдено.</div>';
        return;
      }
      const header = `<thead><tr>
        <th>#</th><th>Severity</th><th>Rule</th><th>Message</th><th>Page</th><th>Snippet</th>
      </tr></thead>`;
      const body = items.map((v, i) => {
        const sev = (v.severity || v.level || "").toString().toUpperCase();
        const rule = v.rule_code || v.code || v.rule || "";
        const msg = v.message || v.msg || "";
        const page = v.page != null ? v.page : (v.location || "");
        const snip = v.snippet || v.text || "";
        return `<tr>
          <td>${i+1}</td>
          <td class="sev-${sev}">${sev || "-"}</td>
          <td><code>${rule}</code></td>
          <td>${(msg+"").replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</td>
          <td>${page}</td>
          <td>${(snip+"").replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</td>
        </tr>`;
      }).join("");
      violTableWrap.innerHTML = `<div class="card"><table>${header}<tbody>${body}</tbody></table></div>`;
    }

    async function probeBase() {
      const origin = window.location.origin;
      const tries = ["/ingest", "/v1/ingest"].map(p => origin + p);
      for (const url of tries) {
        try {
          const res = await fetch(url, { method: "OPTIONS" });
          if (res.ok || [200, 204, 405].includes(res.status)) {
            apiBaseInput.value = new URL(url).pathname.replace(/\/ingest$/, "");
            alert("Выбран базовый путь: " + apiBaseInput.value);
            return;
          }
        } catch (e) {}
      }
      alert("Не удалось автоматически определить базовый путь. Укажите вручную (например, / или /v1).");
    }

    btnProbe.addEventListener("click", probeBase);

    // Upload
    uploadBtn.addEventListener("click", async () => {
      uploadResult.innerHTML = "";
      const f = fileInput.files?.[0];
      if (!f) { uploadResult.innerHTML = errHtml("Выберите файл"); return; }
      uploadBtn.disabled = true;

      const fd = new FormData();
      fd.append("file", f);
      const dept = deptInput.value.trim();
      const source = sourceInput.value.trim();
      if (dept) fd.append("dept", dept);
      if (source) fd.append("source", source);

      try {
        const res = await fetch(base() + "/ingest", { method: "POST", body: fd });
        const txt = await res.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        if (!res.ok) {
          uploadResult.innerHTML = errHtml("Ошибка загрузки", txt);
        } else {
          const docId = data.doc_id || data.id || data.document_id;
          let html = `<div class="card"><div>Ответ:</div><pre class="small">${j(data)}</pre></div>`;
          if (docId) {
            docIdInput.value = docId;
            html = `<div class="card"><div>Документ загружен. doc_id: <code>${docId}</code></div></div>` + html;
          }
          uploadResult.innerHTML = html;
        }
      } catch (e) {
        uploadResult.innerHTML = errHtml(e.message || e);
      } finally {
        uploadBtn.disabled = false;
      }
    });

    // Validate
    validateBtn.addEventListener("click", async () => {
      valResult.innerHTML = "";
      const id = docIdInput.value.trim();
      if (!id) { valResult.innerHTML = errHtml("Укажите doc_id"); return; }
      validateBtn.disabled = true;
      try {
        const res = await fetch(base() + "/validate/" + encodeURIComponent(id));
        const txt = await res.text();
        let data; try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        if (!res.ok) {
          valResult.innerHTML = errHtml("Ошибка проверки", txt);
        } else {
          valResult.innerHTML = `<div class="card"><div>Ответ:</div><pre class="small">${j(data)}</pre></div>`;
        }
      } catch (e) {
        valResult.innerHTML = errHtml(e.message || e);
      } finally {
        validateBtn.disabled = false;
      }
    });

    // Report
    reportBtn.addEventListener("click", async () => {
      violTableWrap.innerHTML = "";
      reportSummary.innerHTML = "";
      const id = docIdInput.value.trim();
      if (!id) { violTableWrap.innerHTML = errHtml("Укажите doc_id"); return; }
      reportBtn.disabled = true;
      try {
        const res = await fetch(base() + "/report/" + encodeURIComponent(id));
        const txt = await res.text();
        let data; try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        if (!res.ok) {
          violTableWrap.innerHTML = errHtml("Ошибка получения отчёта", txt);
        } else {
          // Try common shapes
          const metrics = data.metrics || data.summary || data.stats || null;
          const violations = data.violations || data.items || data.findings || [];
          summaryKV({ ...metrics, doc_id: data.doc_id || id, filename: data.filename, dept: data.dept, source: data.source });
          renderViolations(violations);
        }
      } catch (e) {
        violTableWrap.innerHTML = errHtml(e.message || e);
      } finally {
        reportBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
